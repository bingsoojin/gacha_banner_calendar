<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gacha Banner Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Luxon (dates/timezones) -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

  <!-- DARK MODE PRE-INIT: set .dark before paint -->
  <script>
  (function(){
    try{
      const saved  = localStorage.getItem('theme');
      const system = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      if ((saved || system) === 'dark') document.documentElement.classList.add('dark');
    }catch(e){}
  })();
  </script>

  <!-- THEME: variables + overrides (placed after any other styles) -->
  <style>
    :root{
      --bg:#ffffff; --text:#0f172a; --muted:#475569;
      --card:#f8fafc; --border:#e2e8f0; --chip:#e2e8f0; --accent:#2563eb;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    .dark{
      color-scheme: dark;
      --bg:#0b1120; --text:#e5e7eb; --muted:#94a3b8;
      --card:#0f172a; --border:#1f2937; --chip:#111827; --accent:#60a5fa;
      --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
    }
    html, body { background:var(--bg) !important; color:var(--text) !important; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    a { color:var(--accent) !important; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px 48px; }
    .toolbar { display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .toolbar-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .toolbar-right { display:flex; align-items:center; gap:8px; }

    .btn {
      background: var(--card); color: var(--text); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
    }
    .btn:disabled { opacity: .6; cursor: default; }
    .seg { display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .seg button { background:var(--card); color:var(--text); padding:8px 12px; border:0; cursor:pointer; }
    .seg button[aria-pressed="true"] { background:var(--chip); font-weight:600; }
    .theme-toggle{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      border-radius:9999px; padding:8px 10px; cursor:pointer; line-height:1;
    }
    .title { font-weight:800; letter-spacing:.2px; }
    .subtle { color:var(--muted); font-size:13px; }

    /* Month grid */
    .month-head { display:flex; align-items:center; gap:10px; margin-top:14px; margin-bottom:8px; }
    .month-head .spacer { flex:1; }
    .month { border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--card); }
    .dow { display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--border); }
    .dow div { background:var(--card); text-align:center; padding:8px 0; font-size:12px; color:var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--border); }
    .cell { background:var(--card); min-height:104px; padding:8px; position:relative; }
    .daynum { font-size:12px; color:var(--muted); }
    .cell.today .daynum { color: var(--accent); font-weight:700; }
    .chip {
      display:inline-block; margin:4px 0 0; padding:4px 6px; font-size:12px;
      border-radius:8px; background:var(--chip); border:1px solid var(--border); color:var(--text);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
    }
    .chip .g { font-weight:600; }
    .chip .t { color:var(--muted); font-weight:600; margin-left:6px; }
    .chip .tag { margin-left:6px; font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); background:transparent; }
    .pill-ok   { border-color: var(--ok);   color: var(--ok); }
    .pill-warn { border-color: var(--warn); color: var(--warn); }
    .pill-neu  { border-color: var(--muted); color: var(--muted); }
    .pill-zzzw { border-color: var(--accent); color: var(--accent); }

    /* Upcoming/List */
    .list { margin-top:16px; display:grid; gap:8px; }
    .row {
      display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card);
    }
    .row .when { min-width: 220px; color:var(--muted); font-size:13px; }
    .row .who  { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .row .who .name { font-weight:600; }
    .row .meta { display:flex; gap:6px; align-items:center; }
    .row .meta .tag { font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }

    footer { margin-top:26px; padding-top:14px; border-top:1px solid var(--border); color:var(--muted); font-size:13px; }

    /* Simple hide helper */
    .hidden { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <div>
          <div class="title">Gacha Banner Calendar</div>
          <div class="subtle">Auto-updated nightly ¬∑ times shown in your timezone</div>
        </div>
      </div>
      <div class="toolbar-right">
        <div class="seg" role="tablist" aria-label="View">
          <button id="btnMonth" aria-pressed="true">Month</button>
          <button id="btnUpcoming" aria-pressed="false">Upcoming</button>
        </div>
        <button id="btnExport" class="btn" title="Export visible range as .ics">Export .ics</button>
        <button id="btnDark" class="theme-toggle" aria-pressed="false" title="Toggle dark mode">üåô</button>
      </div>
    </div>

    <!-- Month view -->
    <div id="monthView" class="month-view">
      <div class="month-head">
        <button id="btnPrev" class="btn" title="Previous month">‚Üê</button>
        <div id="monthLabel" style="font-weight:700;"></div>
        <div class="spacer"></div>
        <button id="btnNext" class="btn" title="Next month">‚Üí</button>
      </div>
      <div class="month">
        <div class="dow">
          <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div id="monthGrid" class="grid"></div>
      </div>
    </div>

    <!-- Upcoming view -->
    <div id="listView" class="hidden">
      <div id="liveNow" class="list"></div>
      <h3 style="margin:18px 0 8px;">Upcoming</h3>
      <div id="upcomingList" class="list"></div>
    </div>

    <footer id="footer">
      Built for: Honkai: Star Rail ‚Ä¢ Zenless Zone Zero ‚Ä¢ <strong>Genshin Impact</strong> ‚Ä¢ Wuthering Waves ‚Ä¢ Girls‚Äô Frontline 2
      <div style="margin-top:6px;">Data source credits shown per entry (hover for tooltip).</div>
    </footer>
  </div>

  <script>
    // ==== Global state ====
    const { DateTime, Interval } = luxon;

    const GAME_META = {
      HSR:  { label: 'Honkai: Star Rail' },
      ZZZ:  { label: 'Zenless Zone Zero' },
      GI:   { label: 'Genshin Impact' }, // ensure full name everywhere
      WUWA: { label: 'Wuthering Waves' },
      GF2:  { label: "Girls‚Äô Frontline 2" }
    };

    const state = {
      tz: DateTime.local().zoneName,
      view: 'month',
      monthCursor: DateTime.local().startOf('month'),
      data: []
    };

    // ==== Theme (runtime) ====
    const THEME_KEY = 'theme';
    function applyTheme(mode){
      const isDark = mode === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      const b = document.getElementById('btnDark');
      if(b){
        b.setAttribute('aria-pressed', String(isDark));
        b.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      }
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      const pref = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      applyTheme(saved || pref);
    }
    function toggleTheme(){
      const isDark = !document.documentElement.classList.contains('dark');
      applyTheme(isDark ? 'dark' : 'light');
      localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
    }

    // ==== Data load ====
    async function loadData(){
      try {
        const resp = await fetch('banners.json?t=' + Date.now(), { cache: 'no-cache' });
        const raw = await resp.text();
        let parsed = null;
        try { parsed = JSON.parse(raw); } catch {}
        if (typeof parsed === 'string') { try { parsed = JSON.parse(parsed); } catch { parsed = null; } }
        if (!Array.isArray(parsed)) parsed = [];
        state.data = parsed.map(x => ({
          ...x,
          start: DateTime.fromISO(x.start, { zone: 'utc' }),
          end:   DateTime.fromISO(x.end,   { zone: 'utc' })
        }));
      } catch {
        state.data = [];
      }
    }

    function visibleBanners(){
      // Basic filter: all games; extend with toggles later if needed
      return state.data;
    }

    // ==== Rendering ====
    function render(){
      document.getElementById('btnMonth').setAttribute('aria-pressed', String(state.view==='month'));
      document.getElementById('btnUpcoming').setAttribute('aria-pressed', String(state.view==='upcoming'));
      document.getElementById('monthView').classList.toggle('hidden', state.view!=='month');
      document.getElementById('listView').classList.toggle('hidden', state.view!=='upcoming');
      if(state.view==='month') renderMonth(); else renderUpcoming();
    }

    function renderMonth(){
      const label = state.monthCursor.toFormat('MMMM yyyy');
      document.getElementById('monthLabel').textContent = label;

      const grid = document.getElementById('monthGrid');
      grid.innerHTML = '';

      // Start Monday; compute first cell
      const startOfMonth = state.monthCursor.startOf('month');
      const startWeekday = (startOfMonth.weekday + 6) % 7; // 0=Mon .. 6=Sun
      const firstCellDate = startOfMonth.minus({ days: startWeekday });

      const banners = visibleBanners();

      for(let i=0;i<42;i++){
        const day = firstCellDate.plus({ days:i }).setZone(state.tz);
        const cell = document.createElement('div');
        cell.className = 'cell' + (day.hasSame(DateTime.local(), 'day') ? ' today' : '');

        const dn = document.createElement('div');
        dn.className = 'daynum';
        dn.textContent = day.toFormat('d');
        cell.appendChild(dn);

        // Local-day overlap: avoid off-by-one
        const cellStart = day.startOf('day');
        const cellEnd   = day.endOf('day');

        const matches = banners.filter(b => {
          const s = b.start.setZone(state.tz).startOf('day');
          const e = b.end.setZone(state.tz).endOf('day');
          return Interval.fromDateTimes(s, e).overlaps(Interval.fromDateTimes(cellStart, cellEnd));
        });

        for(const b of matches){
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.title = tooltipFor(b);

          const meta = GAME_META[b.game] || { label: b.game };
          chip.innerHTML = `<span class="g">${meta.label}</span><span class="t">‚Ä¢</span> ${escapeHtml(b.name)} ${tagsHTML(b)}`;
          cell.appendChild(chip);
        }

        grid.appendChild(cell);
      }
    }

    function renderUpcoming(){
      const now = DateTime.now();
      const banners = visibleBanners();
      const live = banners.filter(b => b.start <= now && b.end >= now)
                          .sort((a,b)=> a.end - b.end);
      const future = banners.filter(b => b.start > now)
                            .sort((a,b)=> a.start - b.start);

      const elLive = document.getElementById('liveNow');
      const elUp   = document.getElementById('upcomingList');
      elLive.innerHTML = ''; elUp.innerHTML = '';

      if(live.length===0){
        const empty = document.createElement('div');
        empty.className = 'row';
        empty.innerHTML = `<div class="when">Now</div><div class="who">No banners live.</div>`;
        elLive.appendChild(empty);
      }else{
        for(const b of live.slice(0, 10)){
          elLive.appendChild(rowItem(b, true));
        }
      }
      for(const b of future.slice(0, 40)){
        elUp.appendChild(rowItem(b, false));
      }
    }

    function rowItem(b, isLive){
      const r = document.createElement('div');
      r.className = 'row'; r.title = tooltipFor(b);

      const sLocal = b.start.setZone(state.tz).toFormat('LLL d');
      const eLocal = b.end.setZone(state.tz).toFormat('LLL d');
      const when = document.createElement('div');
      when.className = 'when';
      when.textContent = isLive ? `Live ‚Ä¢ ends ${eLocal}` : `${sLocal} ‚Üí ${eLocal}`;

      const who = document.createElement('div');
      who.className = 'who';
      const meta = GAME_META[b.game] || { label: b.game };
      who.innerHTML = `<span class="name">${meta.label} ‚Ä¢ ${escapeHtml(b.name)}</span> ${tagsHTML(b)}`;

      const metaBox = document.createElement('div');
      metaBox.className = 'meta';
      if (b.status){
        const st = document.createElement('span');
        st.className = 'tag ' + (b.status==='current' ? 'pill-ok' : b.status==='upcoming' ? 'pill-warn' : 'pill-neu');
        st.textContent = b.status[0].toUpperCase() + b.status.slice(1);
        metaBox.appendChild(st);
      }
      const link = document.createElement('a');
      link.href = b.source || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.className = 'tag';
      link.textContent = 'Source';
      metaBox.appendChild(link);

      r.appendChild(when);
      r.appendChild(who);
      r.appendChild(metaBox);
      return r;
    }

    function tagsHTML(b){
      const tags = [];
      if (b.version) tags.push(`<span class="tag">v${escapeHtml(b.version)}${b.phase_num?` P${b.phase_num}`:''}</span>`);
      if (b.rerun)   tags.push(`<span class="tag">Rerun</span>`);
      if (b.banner_type === 'Light Cone') tags.push(`<span class="tag">LC</span>`);
      if (b.banner_type === 'W-Engine')   tags.push(`<span class="tag pill-zzzw">W-Engine</span>`);
      return tags.join(' ');
    }

    function tooltipFor(b){
      const meta = GAME_META[b.game] || { label: b.game };
      const localStart = b.start.setZone(state.tz).toFormat('DDDD');
      const localEnd   = b.end.setZone(state.tz).toFormat('DDDD');
      const vpf = (b.version ? ` v${b.version}` : '') + (b.phase_num ? ` P${b.phase_num}` : '');
      const rr  = b.rerun ? ' [Rerun]' : '';
      return `${meta.label}\n${b.name}${rr}${vpf}\n${localStart} ‚Üí ${localEnd}`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ==== ICS export (all-day) ====
    function exportICS(){
      const banners = visibleBanners();
      const nowUTC = DateTime.utc().toFormat("yyyyMMdd'T'HHmmss'Z'");
      let set = [];
      if(state.view==='month'){
        const mStart = state.monthCursor.setZone(state.tz).startOf('month');
        const mEnd   = state.monthCursor.setZone(state.tz).endOf('month');
        set = banners.filter(b => {
          const iv = Interval.fromDateTimes(
            b.start.setZone(state.tz).startOf('day'),
            b.end.setZone(state.tz).endOf('day')
          );
          const cell = Interval.fromDateTimes(mStart, mEnd);
          return iv.overlaps(cell);
        });
      }else{
        const now = DateTime.now();
        set = banners.filter(b => b.end > now);
      }
      const lines = [
        "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BannerCal//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
      ];
      set.forEach((b,i)=>{
        const meta = GAME_META[b.game] || { label: b.game };
        const uid = `${b.game}-${i}-${b.start.toMillis()}@bannercal`;
        lines.push(
          "BEGIN:VEVENT",
          `UID:${uid}`,
          `DTSTAMP:${nowUTC}`,
          // All-day ICS: local start date, end exclusive (+1 day)
          `DTSTART;VALUE=DATE:${b.start.setZone(state.tz).startOf('day').toFormat('yyyyMMdd')}`,
          `DTEND;VALUE=DATE:${b.end.setZone(state.tz).plus({ days: 1 }).startOf('day').toFormat('yyyyMMdd')}`,
          `SUMMARY:${(meta.label + ' ‚Ä¢ ' + b.name).replace(/[\n,;]/g, ' ')}`,
          `DESCRIPTION:${((b.phase?('Phase '+b.phase+' \n'):'') + (b.notes||'')).replace(/[\n,;]/g, ' ')}`,
          "END:VEVENT"
        );
      });
      lines.push("END:VCALENDAR");
      const blob = new Blob([lines.join("\r\n")], {type:'text/calendar;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `banner-cal-${state.view==='month'?state.monthCursor.toFormat("yyyy-LL"):'upcoming'}.ics`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    // ==== Init / events ====
    document.addEventListener('DOMContentLoaded', async ()=>{
      initTheme();

      // Controls
      document.getElementById('btnDark').addEventListener('click', toggleTheme);
      document.getElementById('btnMonth').addEventListener('click', ()=>{ state.view='month'; render(); });
      document.getElementById('btnUpcoming').addEventListener('click', ()=>{ state.view='upcoming'; render(); });
      document.getElementById('btnPrev').addEventListener('click', ()=>{ state.monthCursor = state.monthCursor.minus({ months:1 }); render(); });
      document.getElementById('btnNext').addEventListener('click', ()=>{ state.monthCursor = state.monthCursor.plus({ months:1 }); render(); });
      document.getElementById('btnExport').addEventListener('click', exportICS);

      await loadData();
      render();
    });
  </script>
</body>
</html>
