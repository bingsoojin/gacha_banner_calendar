<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gacha Banner Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Luxon (dates/timezones) -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

  <!-- DARK MODE PRE-INIT -->
  <script>
  (function(){
    try{
      const saved  = localStorage.getItem('theme');
      const system = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      if ((saved || system) === 'dark') document.documentElement.classList.add('dark');
    }catch(e){}
  })();
  </script>

  <!-- THEME -->
  <style>
    :root{
      --bg:#ffffff; --text:#0f172a; --muted:#475569;
      --card:#f8fafc; --border:#e2e8f0; --chip:#e2e8f0; --accent:#2563eb;
      --hsr:#8b5cf6; --zzz:#06b6d4; --gi:#22c55e; --wuwa:#f59e0b; --gf2:#ef4444;
    }
    .dark{
      color-scheme: dark;
      --bg:#0b1120; --text:#e5e7eb; --muted:#94a3b8;
      --card:#0f172a; --border:#1f2937; --chip:#111827; --accent:#60a5fa;
      --hsr:#a78bfa; --zzz:#22d3ee; --gi:#4ade80; --wuwa:#fbbf24; --gf2:#f87171;
    }
    html, body { background:var(--bg) !important; color:var(--text) !important; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    a { color:var(--accent) !important; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px 48px; }

    .toolbar { display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap; }
    .toolbar-left { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .title { font-weight:800; letter-spacing:.2px; }
    .subtle { color:var(--muted); font-size:13px; }
    .toolbar-right { display:flex; align-items:center; gap:8px; }

    .seg { display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .seg button { background:var(--card); color:var(--text); padding:8px 12px; border:0; cursor:pointer; }
    .seg button[aria-pressed="true"] { background:var(--chip); font-weight:600; }

    .btn { background: var(--card); color: var(--text); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; }
    .btn:disabled { opacity: .6; cursor: default; }

    .pillbar { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .pill { border:1px solid var(--border); background:var(--card); color:var(--text); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:13px; }
    .pill[aria-pressed="true"] { background:var(--chip); font-weight:600; }

    .theme-toggle{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      border-radius:9999px; padding:8px 10px; cursor:pointer; line-height:1;
    }

    /* Current strip */
    .current-strip { margin-top:14px; display:grid; gap:8px; }
    .current-card { display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .game-tag { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); }
    .status-chip { font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); margin-left:6px; color:var(--muted); }

    /* Month calendar like Game8 (7 columns, week rows, bars spanning) */
    .month-head { display:flex; align-items:center; gap:10px; margin-top:16px; margin-bottom:8px; }
    .month-head .spacer { flex:1; }
    .month { border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--card); }
    .dow { display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--border); }
    .dow div { background:var(--card); text-align:center; padding:8px 0; font-size:12px; color:var(--muted); }
    .week { border-top:1px solid var(--border); }
    .week-dates { display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--border); }
    .datecell { background:var(--card); padding:6px 8px; font-size:12px; color:var(--muted); }
    .datecell.today { color:var(--accent); font-weight:700; }
    .week-bars { display:grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 24px; gap:2px 1px; padding:6px; }

    .bar {
      font-size:12px; border-radius:8px; padding:2px 6px; color:#0b1320;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      align-self:center;
    }
    .dark .bar { color:#0b1320; } /* bars use light text-on-colored pills; keep readable */

    .bar.hsr { background: linear-gradient(0deg, var(--hsr), var(--hsr)); }
    .bar.zzz { background: linear-gradient(0deg, var(--zzz), var(--zzz)); }
    .bar.gi  { background: linear-gradient(0deg, var(--gi),  var(--gi)); }
    .bar.wu  { background: linear-gradient(0deg, var(--wuwa),var(--wuwa)); }
    .bar.gf2 { background: linear-gradient(0deg, var(--gf2), var(--gf2)); }

    .bar .abbr { font-weight:800; }
    .bar .name { margin-left:6px; font-weight:600; }
    .bar .tag { margin-left:6px; font-size:10px; padding:0 6px; border-radius:999px; background:rgba(255,255,255,.45); }

    /* Upcoming list */
    .list { margin-top:16px; display:grid; gap:8px; }
    .row { display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .row .when { min-width: 220px; color:var(--muted); font-size:13px; }
    .row .who  { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .row .who .name { font-weight:600; }
    .row .meta { display:flex; gap:6px; align-items:center; }
    .row .meta .tag { font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }

    footer { margin-top:26px; padding-top:14px; border-top:1px solid var(--border); color:var(--muted); font-size:13px; }

    .hidden { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <div>
          <div class="title">Gacha Banner Calendar</div>
          <div class="subtle">Auto-updated nightly ¬∑ times shown in your timezone</div>
        </div>
      </div>
      <div class="toolbar-right">
        <div class="seg" role="tablist" aria-label="View">
          <button id="btnMonth" aria-pressed="true">Month</button>
          <button id="btnUpcoming" aria-pressed="false">Upcoming</button>
        </div>
        <button id="btnExport" class="btn" title="Export visible range as .ics">Export .ics</button>
        <button id="btnDark" class="theme-toggle" aria-pressed="false" title="Toggle dark mode">üåô</button>
      </div>
    </div>

    <!-- Filter pills -->
    <div class="pillbar" id="filterBar" role="group" aria-label="Game filters"></div>

    <!-- Current banners strip (for selected games) -->
    <div id="currentStrip" class="current-strip"></div>

    <!-- Month view -->
    <div id="monthView" class="month-view">
      <div class="month-head">
        <button id="btnPrev" class="btn" title="Previous month">‚Üê</button>
        <div id="monthLabel" style="font-weight:700;"></div>
        <div class="spacer"></div>
        <button id="btnNext" class="btn" title="Next month">‚Üí</button>
      </div>
      <div class="month" id="monthCal">
        <div class="dow">
          <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div id="weeks"></div>
      </div>
    </div>

    <!-- Upcoming view -->
    <div id="listView" class="hidden">
      <div id="liveNow" class="list"></div>
      <h3 style="margin:18px 0 8px;">Upcoming</h3>
      <div id="upcomingList" class="list"></div>
    </div>

    <footer id="footer">
      Built for: Honkai: Star Rail ‚Ä¢ Zenless Zone Zero ‚Ä¢ <strong>Genshin Impact</strong> ‚Ä¢ Wuthering Waves ‚Ä¢ Girls‚Äô Frontline 2
      <div style="margin-top:6px;">Hover any item for source + local dates. Filters hide Light Cones, W-Engines and weapons by design.</div>
    </footer>
  </div>

  <script>
    const { DateTime, Interval } = luxon;

    // Labels (full + abbreviated)
    const GAME_LABEL = {
      HSR:  'Honkai: Star Rail',
      ZZZ:  'Zenless Zone Zero',
      GI:   'Genshin Impact',
      WUWA: 'Wuthering Waves',
      GF2:  "Girls‚Äô Frontline 2"
    };
    const GAME_ABBR = { HSR:'HSR', ZZZ:'ZZZ', GI:'GI', WUWA:'WUWA', GF2:'GFL2' };
    const GAME_ORDER = ['HSR','ZZZ','GI','WUWA','GF2'];

    // State
    const state = {
      tz: DateTime.local().zoneName,
      view: 'month',
      monthCursor: DateTime.local().startOf('month'),
      data: [],
      filter: new Set(GAME_ORDER), // start with All
    };

    // Theme
    const THEME_KEY = 'theme';
    function applyTheme(mode){
      const isDark = mode === 'dark';
      document.documentElement.classList.toggle('dark', isDark);
      const b = document.getElementById('btnDark');
      if(b){ b.setAttribute('aria-pressed', String(isDark)); b.textContent = isDark ? '‚òÄÔ∏è' : 'üåô'; }
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      const pref = matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      applyTheme(saved || pref);
    }
    function toggleTheme(){
      const isDark = !document.documentElement.classList.contains('dark');
      applyTheme(isDark ? 'dark' : 'light');
      localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
    }

    // Data load (robust)
    async function loadData(){
      try {
        const resp = await fetch('banners.json?t='+Date.now(), { cache:'no-cache' });
        const raw = await resp.text();
        let parsed = null;
        try { parsed = JSON.parse(raw); } catch {}
        if (typeof parsed === 'string') { try { parsed = JSON.parse(parsed); } catch { parsed = null; } }
        if (!Array.isArray(parsed)) parsed = [];
        state.data = parsed.map(x => ({
          ...x,
          start: DateTime.fromISO(x.start, { zone:'utc' }),
          end:   DateTime.fromISO(x.end,   { zone:'utc' })
        }));
      } catch { state.data = []; }
    }

    // Inclusion rules
    function includeBanner(b){
      // Game filter
      if (!state.filter.has(b.game)) return false;

      // Hide unwanted banner types
      const bt = (b.banner_type || '').toLowerCase();
      if (b.game==='HSR' && bt.includes('light cone')) return false;
      if (bt.includes('w-engine')) return false;          // ZZZ W-Engines
      if (bt.includes('weapon')) return false;            // GI/WUWA weapons if ever present

      // Hide 4-star/A-rank reruns when metadata is present
      const notes = (b.notes||'').toLowerCase();
      if (b.rerun && (
          b.stars===4 ||
          /4.?star|4‚òÖ/.test(notes) ||
          /a-?rank/.test(notes)
      )) return false;

      return true;
    }

    function visibleBanners(){
      return state.data.filter(includeBanner);
    }

    // Filter pills
    function buildFilterBar(){
      const bar = document.getElementById('filterBar');
      bar.innerHTML = '';
      const make = (id, label) => {
        const btn = document.createElement('button');
        btn.className = 'pill';
        btn.textContent = label;
        btn.setAttribute('aria-pressed', String(state.filter.has(id)));
        btn.addEventListener('click', ()=>{
          if (id==='ALL'){
            state.filter = new Set(GAME_ORDER);
            Array.from(bar.children).forEach(c=>c.setAttribute('aria-pressed','false'));
            Array.from(bar.children).forEach(c=>{ if(c.dataset.id!=='ALL'){ c.setAttribute('aria-pressed','true'); }});
          }else{
            if (state.filter.has(id)) {
              if (state.filter.size>1) state.filter.delete(id); // keep at least one
            } else {
              state.filter.add(id);
            }
            // update toggles
            Array.from(bar.children).forEach(c=>{
              if(c.dataset.id==='ALL'){
                c.setAttribute('aria-pressed','false');
              }else{
                c.setAttribute('aria-pressed', String(state.filter.has(c.dataset.id)));
              }
            });
          }
          render();
        });
        btn.dataset.id = id;
        return btn;
      };
      bar.appendChild(make('ALL','All'));
      for(const g of GAME_ORDER){
        bar.appendChild(make(g, GAME_LABEL[g]));
      }
    }

    // Current banners strip
    function renderCurrentStrip(){
      const el = document.getElementById('currentStrip');
      el.innerHTML = '';
      const now = DateTime.now();
      const byGame = new Map();
      for(const g of state.filter) byGame.set(g, []);

      for(const b of visibleBanners()){
        if (b.start <= now && b.end >= now && byGame.has(b.game)){
          byGame.get(b.game).push(b);
        }
      }
      for(const g of GAME_ORDER){
        if (!state.filter.has(g)) continue;
        const arr = byGame.get(g)||[];
        if (arr.length===0) continue;
        // show up to two current entries
        for(const b of arr.slice(0,2)){
          const card = document.createElement('div');
          card.className = 'current-card';
          const tag = document.createElement('span');
          tag.className = 'game-tag';
          tag.textContent = GAME_LABEL[b.game];
          const name = document.createElement('div');
          const s = b.start.setZone(state.tz).toFormat('LLL d');
          const e = b.end.setZone(state.tz).toFormat('LLL d');
          name.innerHTML = `<strong>${escapeHtml(b.name)}</strong> <span class="subtle">‚Ä¢ ${s} ‚Üí ${e}</span>`;
          const status = document.createElement('span');
          if (b.status){
            status.className = 'status-chip';
            status.textContent = b.status[0].toUpperCase() + b.status.slice(1);
          }
          card.appendChild(tag);
          card.appendChild(name);
          if (b.status) card.appendChild(status);
          el.appendChild(card);
        }
      }
    }

    // Month calendar with spanning bars
    function renderMonth(){
      document.getElementById('monthLabel').textContent = state.monthCursor.toFormat('MMMM yyyy');

      const weeksEl = document.getElementById('weeks');
      weeksEl.innerHTML = '';

      const startOfMonth = state.monthCursor.startOf('month');
      const startWeekdayIdx = (startOfMonth.weekday + 6) % 7; // 0=Mon
      const firstMonday = startOfMonth.minus({ days: startWeekdayIdx });
      const banners = visibleBanners();

      for(let w=0; w<6; w++){
        const wStart = firstMonday.plus({ days: w*7 }).setZone(state.tz).startOf('day');
        const wEnd   = wStart.plus({ days: 6 }).endOf('day');

        // Dates row
        const dateRow = document.createElement('div');
        dateRow.className = 'week-dates';
        for(let i=0;i<7;i++){
          const d = wStart.plus({ days:i });
          const cell = document.createElement('div');
          cell.className = 'datecell' + (d.hasSame(DateTime.local(), 'day') ? ' today':'');
          cell.textContent = d.toFormat('d');
          dateRow.appendChild(cell);
        }

        // Bars
        const barGrid = document.createElement('div');
        barGrid.className = 'week-bars';

        // Segment banners to this week and lay them on tracks
        const segs = [];
        for(const b of banners){
          const s = b.start.setZone(state.tz);
          const e = b.end.setZone(state.tz);
          const ovStart = s > wStart ? s : wStart;
          const ovEnd   = e < wEnd   ? e : wEnd;
          if (ovEnd < wStart || ovStart > wEnd) continue;

          // compute grid start (1..7) and span (1..7)
          const startCol = Math.max(1, Math.min(7, Math.floor(ovStart.diff(wStart,'days').days) + 1));
          const endCol   = Math.max(1, Math.min(7, Math.floor(ovEnd.diff(wStart,'days').days) + 1));
          const span = Math.max(1, endCol - startCol + 1);

          segs.push({ b, startCol, span });
        }

        // Track assignment (greedy)
        const tracks = []; // each track: [{startCol, endCol}]
        function placeOnTrack(seg){
          for(let t=0;t<tracks.length;t++){
            const used = tracks[t];
            let clash = false;
            for(const u of used){
              const A1 = seg.startCol, A2 = seg.startCol + seg.span - 1;
              const B1 = u.startCol,  B2 = u.endCol;
              if (!(A2 < B1 || A1 > B2)) { clash = true; break; }
            }
            if (!clash){ used.push({startCol: seg.startCol, endCol: seg.startCol+seg.span-1}); return t+1; }
          }
          tracks.push([{startCol: seg.startCol, endCol: seg.startCol+seg.span-1}]);
          return tracks.length;
        }

        for(const seg of segs){
          const row = placeOnTrack(seg);
          const div = document.createElement('div');
          const g = seg.b.game;
          div.className = 'bar ' + (g==='HSR'?'hsr':g==='ZZZ'?'zzz':g==='GI'?'gi':g==='WUWA'?'wu':'gf2');
          div.style.gridColumn = `${seg.startCol} / span ${seg.span}`;
          div.style.gridRow = String(row);

          // Abbreviated label on calendar
          const ab = GAME_ABBR[g] || g;
          const tags = [];
          if (seg.b.rerun) tags.push('Rerun');
          if (seg.b.status) tags.push(seg.b.status[0].toUpperCase()+seg.b.status.slice(1));
          div.title = tooltipFor(seg.b);
          div.innerHTML = `<span class="abbr">${ab}</span><span class="name">${escapeHtml(seg.b.name)}</span>${tags.length?` <span class="tag">${tags.join(' ¬∑ ')}</span>`:''}`;
          barGrid.appendChild(div);
        }

        const weekWrap = document.createElement('div');
        weekWrap.className = 'week';
        weekWrap.appendChild(dateRow);
        weekWrap.appendChild(barGrid);
        weeksEl.appendChild(weekWrap);
      }
    }

    function renderUpcoming(){
      const now = DateTime.now();
      const banners = visibleBanners();
      const live = banners.filter(b => b.start <= now && b.end >= now)
                          .sort((a,b)=> a.end - b.end);
      const future = banners.filter(b => b.start > now)
                            .sort((a,b)=> a.start - b.start);

      const elLive = document.getElementById('liveNow');
      const elUp   = document.getElementById('upcomingList');
      elLive.innerHTML = ''; elUp.innerHTML = '';

      if(live.length===0){
        const empty = document.createElement('div');
        empty.className = 'row';
        empty.innerHTML = `<div class="when">Now</div><div class="who">No banners live.</div>`;
        elLive.appendChild(empty);
      }else{
        for(const b of live.slice(0, 10)){
          elLive.appendChild(rowItem(b, true));
        }
      }
      for(const b of future.slice(0, 40)){
        elUp.appendChild(rowItem(b, false));
      }
    }

    function rowItem(b, isLive){
      const r = document.createElement('div');
      r.className = 'row'; r.title = tooltipFor(b);
      const sLocal = b.start.setZone(state.tz).toFormat('LLL d');
      const eLocal = b.end.setZone(state.tz).toFormat('LLL d');

      const when = document.createElement('div');
      when.className = 'when';
      when.textContent = isLive ? `Live ‚Ä¢ ends ${eLocal}` : `${sLocal} ‚Üí ${eLocal}`;

      const who = document.createElement('div');
      who.className = 'who';
      who.innerHTML = `<span class="name">${GAME_LABEL[b.game]} ‚Ä¢ ${escapeHtml(b.name)}</span> ${tagsHTML(b)}`;

      const metaBox = document.createElement('div');
      metaBox.className = 'meta';
      if (b.status){
        const st = document.createElement('span');
        st.className = 'tag';
        st.textContent = b.status[0].toUpperCase() + b.status.slice(1);
        metaBox.appendChild(st);
      }
      const link = document.createElement('a');
      link.href = b.source || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.className = 'tag';
      link.textContent = 'Source';
      metaBox.appendChild(link);

      r.appendChild(when);
      r.appendChild(who);
      r.appendChild(metaBox);
      return r;
    }

    function tagsHTML(b){
      const tags = [];
      if (b.version) tags.push(`<span class="tag">v${escapeHtml(b.version)}${b.phase_num?` P${b.phase_num}`:''}</span>`);
      if (b.rerun)   tags.push(`<span class="tag">Rerun</span>`);
      return tags.join(' ');
    }

    function tooltipFor(b){
      const localStart = b.start.setZone(state.tz).toFormat('DDDD');
      const localEnd   = b.end.setZone(state.tz).toFormat('DDDD');
      const vpf = (b.version ? ` v${b.version}` : '') + (b.phase_num ? ` P${b.phase_num}` : '');
      const rr  = b.rerun ? ' [Rerun]' : '';
      return `${GAME_LABEL[b.game]}\n${b.name}${rr}${vpf}\n${localStart} ‚Üí ${localEnd}`;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ICS export (all-day)
    function exportICS(){
      const banners = visibleBanners();
      const nowUTC = DateTime.utc().toFormat("yyyyMMdd'T'HHmmss'Z'");
      let set = [];
      if(state.view==='month'){
        const mStart = state.monthCursor.setZone(state.tz).startOf('month');
        const mEnd   = state.monthCursor.setZone(state.tz).endOf('month');
        set = banners.filter(b => {
          const iv = Interval.fromDateTimes(
            b.start.setZone(state.tz).startOf('day'),
            b.end.setZone(state.tz).endOf('day')
          );
          const mv = Interval.fromDateTimes(mStart, mEnd);
          return iv.overlaps(mv);
        });
      }else{
        const now = DateTime.now();
        set = banners.filter(b => b.end > now);
      }
      const lines = [
        "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//BannerCal//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH",
      ];
      set.forEach((b,i)=>{
        const uid = `${b.game}-${i}-${b.start.toMillis()}@bannercal`;
        lines.push(
          "BEGIN:VEVENT",
          `UID:${uid}`,
          `DTSTAMP:${nowUTC}`,
          `DTSTART;VALUE=DATE:${b.start.setZone(state.tz).startOf('day').toFormat('yyyyMMdd')}`,
          `DTEND;VALUE=DATE:${b.end.setZone(state.tz).plus({ days: 1 }).startOf('day').toFormat('yyyyMMdd')}`,
          `SUMMARY:${(GAME_LABEL[b.game] + ' ‚Ä¢ ' + b.name).replace(/[\n,;]/g, ' ')}`,
          `DESCRIPTION:${((b.phase?('Phase '+b.phase+' \n'):'') + (b.notes||'')).replace(/[\n,;]/g, ' ')}`,
          "END:VEVENT"
        );
      });
      lines.push("END:VCALENDAR");
      const blob = new Blob([lines.join("\r\n")], {type:'text/calendar;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `banner-cal-${state.view==='month'?state.monthCursor.toFormat("yyyy-LL"):'upcoming'}.ics`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    // Init / events
    document.addEventListener('DOMContentLoaded', async ()=>{
      initTheme();

      // View + actions
      document.getElementById('btnDark').addEventListener('click', toggleTheme);
      document.getElementById('btnMonth').addEventListener('click', ()=>{ state.view='month'; render(); });
      document.getElementById('btnUpcoming').addEventListener('click', ()=>{ state.view='upcoming'; render(); });
      document.getElementById('btnPrev').addEventListener('click', ()=>{ state.monthCursor = state.monthCursor.minus({ months:1 }); render(); });
      document.getElementById('btnNext').addEventListener('click', ()=>{ state.monthCursor = state.monthCursor.plus({ months:1 }); render(); });
      document.getElementById('btnExport').addEventListener('click', exportICS);

      // Filters
      buildFilterBar();

      await loadData();
      render();
    });

    function render(){
      // toggle views
      document.getElementById('btnMonth').setAttribute('aria-pressed', String(state.view==='month'));
      document.getElementById('btnUpcoming').setAttribute('aria-pressed', String(state.view==='upcoming'));
      document.getElementById('monthView').classList.toggle('hidden', state.view!=='month');
      document.getElementById('listView').classList.toggle('hidden', state.view!=='upcoming');

      // refresh UI
      renderCurrentStrip();
      if (state.view==='month') renderMonth(); else renderUpcoming();

      // refresh pills pressed states
      const bar = document.getElementById('filterBar');
      Array.from(bar.children).forEach(c=>{
        const id = c.dataset && c.dataset.id;
        if (!id) return;
        if (id==='ALL') c.setAttribute('aria-pressed','false');
        else c.setAttribute('aria-pressed', String(state.filter.has(id)));
      });
    }
  </script>
</body>
</html>
